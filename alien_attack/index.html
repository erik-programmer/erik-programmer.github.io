<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Alien Attack (HTML5)</title>
  <style>
    body {
      margin: 0;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    canvas {
      background: #ffffff;
      display: block;
    }
  </style>
</head>

<body>
  <canvas id="game" width="800" height="600"></canvas>

  <script>
    // ---------------------------------------------------------------
    //                   GAME TRANSLATED FROM LUA
    // ---------------------------------------------------------------

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const W = canvas.width;
    const H = canvas.height;

    // ---------------------------
    // State
    // ---------------------------
    let hero = { lifes: 3 };
    let heart = {};
    let bullets = [];
    let aliens = [];
    let coins = [];
    let alien_bullets = [];

    let simple_bullet_image,
      simple_alien_image,
      simple_alien_exploded_image,
      zig_zag_alien_image,
      zig_zag_alien_exploded_image,
      coin_image,
      rocket_alien_image,
      rocket_alien_exploded_image,
      rocket_alien_rocket_image,
      game_over_image,
      winner_image,
      explosion_sound;

    let points = 0;
    let level = 1;
    let aliens_killed = 0;

    const AlianType = {
      ZIG_ZAG: "zig-zag",
      SIMPLE: "simple",
      ROCKET: "rocket"
    };

    // ---------------------------
    // Input
    // ---------------------------
    const keys = {};
    window.addEventListener("keydown", e => {
      keys[e.key] = true;
      if (e.key === " " || e.code === "Space") fireBullet();
    });
    window.addEventListener("keyup", e => keys[e.key] = false);

    function cloneAudio(a) { return new Audio(a.src); }

    // ---------------------------
    // Collision
    // ---------------------------
    function coll(a, b) {
      return a.x + a.image.width > b.x &&
        a.x < b.x + b.image.width &&
        a.y + a.image.height > b.y &&
        a.y < b.y + b.image.height;
    }

    // ---------------------------
    // Shooting
    // ---------------------------
    function fireBullet() {
      if (!simple_bullet_image) return;

      const mid = hero.x + hero.image.width / 2 - simple_bullet_image.width / 2;

      const addBullet = (xOff) => bullets.push({
        x: mid + xOff,
        y: hero.y,
        image: simple_bullet_image,
        sound: cloneAudio(explosion_sound)
      });

      if (points < 25) addBullet(0);
      else { addBullet(-20); addBullet(20); }
    }

    // ---------------------------
    // Load all assets
    // ---------------------------
    const assetNames = [
      "Fighter.png", "Heart.png", "Simple_bullet.png", "Simple_alien.png", "Simple_alien_exploded.png",
      "Zig_zag_alien.png", "Zig_zag_alien_exploded.png", "Coin.png",
      "Rocket_alien.png", "Rocket_alien_exploded.png", "Rocket_alien_rocket.png",
      "Game_over.png", "Winner.png", "explosion.mp3"
    ];

    function loadImage(name) {
      return new Promise((res, rej) => {
        const img = new Image();
        img.onload = () => res([name, img]);
        img.onerror = rej;
        img.src = name;
      });
    }

    function loadAudio(name) {
      return new Promise((res, rej) => {
        const a = new Audio();
        a.oncanplaythrough = () => res([name, a]);
        a.onerror = rej;
        a.src = name;
        a.load();
      });
    }

    async function loadAssets() {
      const promises = assetNames.map(a =>
        a.endsWith(".png") ? loadImage(a) : loadAudio(a)
      );

      const loaded = await Promise.all(promises);
      const map = Object.fromEntries(loaded);

      hero.image = map["Fighter.png"];
      hero.x = W / 2 - hero.image.width / 2;
      hero.y = H - hero.image.height;

      heart.image = map["Heart.png"];
      simple_bullet_image = map["Simple_bullet.png"];
      simple_alien_image = map["Simple_alien.png"];
      simple_alien_exploded_image = map["Simple_alien_exploded.png"];
      zig_zag_alien_image = map["Zig_zag_alien.png"];
      zig_zag_alien_exploded_image = map["Zig_zag_alien_exploded.png"];
      coin_image = map["Coin.png"];

      rocket_alien_image = map["Rocket_alien.png"];
      rocket_alien_exploded_image = map["Rocket_alien_exploded.png"];
      rocket_alien_rocket_image = map["Rocket_alien_rocket.png"];

      game_over_image = map["Game_over.png"];
      winner_image = map["Winner.png"];

      explosion_sound = map["explosion.mp3"];

      aliens.push({
        x: Math.random() * (W - simple_alien_image.width),
        y: 0,
        image: simple_alien_image,
        type: AlianType.SIMPLE
      });
    }

    // ---------------------------
    // Alien creation logic
    // ---------------------------
    function createAliens() {
      const add = (n, img, type) => {
        for (let i = 0; i < n; i++) {
          aliens.push({
            x: Math.random() * (W - img.width),
            y: 0,
            image: img,
            type: type
          });
        }
      };

      if (level === 1 && aliens.length < 1) add(1, simple_alien_image, AlianType.SIMPLE);
      if (level === 2 && aliens.length < 2) add(2 - aliens.length, simple_alien_image, AlianType.SIMPLE);
      if (level === 3 && aliens.length < 3) add(3 - aliens.length, simple_alien_image, AlianType.SIMPLE);

      if (level === 4 && aliens.length < 3) {
        const zz = aliens.filter(a => a.type === AlianType.ZIG_ZAG).length;
        if (zz < 1) add(1 - zz, zig_zag_alien_image, AlianType.ZIG_ZAG);
        add(3 - aliens.length, simple_alien_image, AlianType.SIMPLE);
      }

      if (level === 5 && aliens.length < 3) {
        const zz = aliens.filter(a => a.type === AlianType.ZIG_ZAG).length;
        if (zz < 2) add(2 - zz, zig_zag_alien_image, AlianType.ZIG_ZAG);
        add(3 - aliens.length, simple_alien_image, AlianType.SIMPLE);
      }

      if (level === 6 && aliens.length < 3) add(3 - aliens.length, zig_zag_alien_image, AlianType.ZIG_ZAG);

      if (level === 7 && aliens.length < 3) {
        const r = aliens.filter(a => a.type === AlianType.ROCKET).length;
        if (r < 1) add(1 - r, rocket_alien_image, AlianType.ROCKET);
        add(3 - aliens.length, zig_zag_alien_image, AlianType.ZIG_ZAG);
      }

      if (level === 8 && aliens.length < 3) {
        const r = aliens.filter(a => a.type === AlianType.ROCKET).length;
        if (r < 2) add(2 - r, rocket_alien_image, AlianType.ROCKET);
        add(3 - aliens.length, zig_zag_alien_image, AlianType.ZIG_ZAG);
      }

      if (level === 9 && aliens.length < 3) add(3 - aliens.length, rocket_alien_image, AlianType.ROCKET);
    }

    // ---------------------------
    // Update loop
    // ---------------------------
    let lastHeartSecond = -1;

    function update() {
      if (hero.lifes > 0 && points < 50) {

        if (keys["ArrowLeft"]) hero.x -= 5;
        if (keys["ArrowRight"]) hero.x += 5;
        hero.x = Math.max(0, Math.min(W - hero.image.width, hero.x));

        bullets.forEach(b => b.y -= 3);
        alien_bullets.forEach(b => b.y += 2.5);

        const t = performance.now() / 1000;

        // rocket alien shooting
        aliens.forEach(a => {
          if (a.type === AlianType.ROCKET) {
            if (!a.bullet_time || a.bullet_time + 5 < t) {
              alien_bullets.push({
                x: a.x + a.image.width / 2 - rocket_alien_rocket_image.width / 2,
                y: a.y + a.image.height,
                image: rocket_alien_rocket_image
              });
              a.bullet_time = t;
            }
          }
        });

        // Heart spawn
        const sec = Math.floor(Date.now() / 1000);
        if (sec % 59 === 0 && heart.x == null && lastHeartSecond !== sec) {
          heart.x = Math.random() * (W - heart.image.width);
          heart.y = 0;
        }
        lastHeartSecond = sec;

        if (heart.x != null) {
          heart.y += 1.3;

          if (coll(heart, hero)) {
            hero.lifes++;
            heart.x = null;
          }
          if (heart.y > H) heart.x = null;
        }

        // Alien movement
        aliens.forEach(a => {
          if (!a.hit_time) {
            if (a.type === AlianType.ROCKET) a.y += 1;
            else a.y += 1.3;

            if (a.type === AlianType.ZIG_ZAG) {
              a.x += (Math.random() * 20 - 10);
              a.x = Math.max(0, Math.min(W - a.image.width, a.x));
            }
          }
        });

        coins.forEach(c => c.y += 2);

        // bullets hit aliens
        aliens.forEach(a => {
          bullets.forEach(b => {
            if (!b.hit && coll(b, a)) {
              if (!a.hit_time) {
                if (a.type === AlianType.SIMPLE) a.image = simple_alien_exploded_image;
                if (a.type === AlianType.ZIG_ZAG) a.image = zig_zag_alien_exploded_image;
                if (a.type === AlianType.ROCKET) a.image = rocket_alien_exploded_image;

                a.hit_time = t;
                b.hit = true;
                b.sound.play();

                coins.push({
                  x: a.x + a.image.width / 2 - coin_image.width / 2,
                  y: a.y + a.image.height,
                  image: coin_image
                });

                aliens_killed++;
              }
            }
          });
        });

        // collect coins
        coins.forEach(c => {
          if (!c.caught && coll(c, hero)) {
            c.caught = true;
            points++;
          }
        });

        // alien hits hero
        aliens.forEach(a => {
          if (!a.crashed && coll(a, hero)) {
            hero.lifes--;
            a.crashed = true;
          }
          if (a.y + a.image.height > H) hero.lifes--;
        });

        // alien bullets hit hero
        alien_bullets.forEach(b => {
          if (!b.hit && coll(b, hero)) {
            hero.lifes--;
            b.hit = true;
          }
        });

        // cleanup
        aliens = aliens.filter(a =>
          (!a.hit_time || a.hit_time + 0.5 > t) &&
          a.y + a.image.height < H &&
          !a.crashed
        );
        bullets = bullets.filter(b => b.y > 0 && !b.hit);
        coins = coins.filter(c => c.y < H && !c.caught);
        alien_bullets = alien_bullets.filter(b => b.y < H && !b.hit);

        // level up
        if (aliens_killed === 10 && level === 1) level++;
        if (aliens_killed > 19 && level === 2) level++;
        if (aliens_killed > 29 && level === 3) level++;
        if (aliens_killed > 39 && level === 4) level++;
        if (aliens_killed > 49 && level === 5) level++;
        if (aliens_killed > 59 && level === 6) level++;
        if (aliens_killed > 69 && level === 7) level++;
        if (aliens_killed > 79 && level === 8) level++;

        createAliens();
      }
    }

    // ---------------------------
    // Draw loop
    // ---------------------------
    function draw() {
      ctx.clearRect(0, 0, W, H);
      ctx.fillStyle = "green";
      ctx.font = "20px Arial";
      ctx.fillText("Lifes " + hero.lifes, 25, 25);
      ctx.fillText("Points " + points + "/50", 25, 50);
      ctx.fillText("Level " + level, 25, 75);
      ctx.fillText("Aliens killed " + aliens_killed, 25, 100);

      if (hero.lifes > 0 && points < 50) {
        if (heart.x != null) ctx.drawImage(heart.image, heart.x, heart.y);
        ctx.drawImage(hero.image, hero.x, hero.y);

        bullets.forEach(b => ctx.drawImage(b.image, b.x, b.y));
        aliens.forEach(a => ctx.drawImage(a.image, a.x, a.y));
        coins.forEach(c => ctx.drawImage(c.image, c.x, c.y));
        alien_bullets.forEach(b => ctx.drawImage(b.image, b.x, b.y));
      } else {
        const img = points < 50 ? game_over_image : winner_image;
        ctx.drawImage(img, W / 2 - img.width / 2, H / 2 - img.height / 2);
      }
    }

    // ---------------------------
    // Main loop
    // ---------------------------
    function loop() {
      update();
      draw();
      requestAnimationFrame(loop);
    }

    // ---------------------------
    // Start
    // ---------------------------
    loadAssets().then(loop);

  </script>
</body>

</html>